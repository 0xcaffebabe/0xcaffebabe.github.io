---
layout: post
title:  "初探ThreadLocal"
date:   2019-05-10T11:59:33
category: JAVA
tags: [JAVA]
---

初探ThreadLocal

<p>在使用spring boot的时候，发现这么样一个很有意思的功能：</p><pre><code>RequestContextHolder.getRequestAttributes()).getRequest()</code></pre><p>可以通过这么样的一个类来获取当前的Request对象，第一反应就是spring boot替我们完成了request对象与当前线程的绑定。</p><p>那这内部，又是如何实现的？</p><p><img src="https://ismy1.oss-cn-qingdao.aliyuncs.com/blog/1557413255826.png" style="max-width:100%;"><br></p><p>这个RequestContenxtHolder里面有一个ThreadLocal对象，这个对象，就是实现数据与线程绑定的核心对象。</p><p>那么ThreadLocal又是什么？</p><p><img src="https://ismy1.oss-cn-qingdao.aliyuncs.com/blog/1557413403768.png" style="max-width:100%;"><br></p><p>从源码的注释大概可以了解到，这个类可以用来实现线程本地变量，我们来做个试验：</p><pre><code>public class Main{<br>    <br>    private ThreadLocal&lt;String&gt; threadLocal = new ThreadLocal&lt;&gt;();<br><br>    public void set(String str){<br>        threadLocal.set(str);<br>    }<br><br>    public String get(){<br>        return threadLocal.get();<br>    }<br><br>    public static void main(String[] args) throws InterruptedException {<br><br>        Main main = new Main();<br>        main.set("hello");<br>        Thread thread = new Thread(()-&gt;main.set("world"));<br><br>        thread.start();<br>        thread.join();<br>        System.out.println(main.get());<br><br>    }<br>}</code></pre><p>当运行这个程序的时候，会输出什么？</p><p>结果是hello，由于thread线程肯定是会在set("hello")之后，join()之前运行完毕的，所以我们可以从这个小例子当中初步了解ThreadLocal的用法。</p><p>那么我们知道，在JAVA内存模型当中，分为公共内存和线程私有内存，或者也叫工作内存。</p><p>线程私有内存是在栈上，那么我们能不能据此判断，ThreadLocal对象是在栈上？</p><p>继续看源码：</p><p>set方法：</p><pre><code>public void set(T value) {<br>        Thread t = Thread.currentThread();<br>        ThreadLocalMap map = getMap(t);<br>        if (map != null) {<br>            map.set(this, value);<br>        } else {<br>            createMap(t, value);<br>        }<br>    }</code></pre><p>get方法：</p><pre><code>public T get() {<br>        Thread t = Thread.currentThread();<br>        ThreadLocalMap map = getMap(t);<br>        if (map != null) {<br>            ThreadLocalMap.Entry e = map.getEntry(this);<br>            if (e != null) {<br>                @SuppressWarnings("unchecked")<br>                T result = (T)e.value;<br>                return result;<br>            }<br>        }<br>        return setInitialValue();<br>    }</code></pre><p>getMap方法：</p><pre><code>ThreadLocalMap getMap(Thread t) {<br>        return t.threadLocals;<br>    }</code></pre><p><br></p><p>从这三个方法来看，线程对象内部有一个ThreadLocal.ThreadLocalMap对象：</p><p><img src="https://ismy1.oss-cn-qingdao.aliyuncs.com/blog/1557413873402.png" style="max-width:100%;"><br></p><p>正是通过这个map，才实现了ThreadLocal与数据的绑定。</p>